#!/usr/bin/env node
var program = require('commander');
var config = require('../config');
var path = require('path');
var urllib = require('urllib');


program.parse(process.argv);
var args = program.args;

if (!args.length) {
  console.log('请输入通知内容');
  process.exit(1);
}

var name;
var content;
if (program.args.length === 1) {
  try {
    var pkgs = require(path.join(process.cwd(),'package.json'));  
    name = pkgs.name;
  } catch (err) {
    console.log('package.json文件无法解析');
    process.exit(1);
  } 
  if (!name) {
    console.log('package.json文件中未指定模块名');
    process.exit(1);
  }
  content = args[0];
} else {
  name = args[0];
  content = args[1];
}

var customConfig = {};
try {
  customConfig = require(config.customConfig);  
} catch(e) {}


if (!customConfig.uid || !customConfig.password) {
  console.log('请先通过tnpm auth进行用户认证');
  process.exit(1);
} 

var NOTIFY_URL = config.alinpmHost + '/tnpm/notify';
console.log('邮件发送中...');
urllib.request(NOTIFY_URL, {
  type: 'post',
  dataType: 'json',
  data: {
    userid: customConfig.uid,
    password: customConfig.password,
    moduleName: name,
    content: content
  }
}, function (err, data) {
  if (err) {
    console.log('服务器返回异常: ' + err.message);
    process.exit(1);
  }
  if (data.status !== 'ok') {
    console.log(data.message);
    process.exit(1);
  }
  console.log('邮件发送成功');
});
